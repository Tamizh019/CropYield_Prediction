<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard - AgriVision</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div class="app-container">
        <div class="sidebar">
            <div class="brand">üå± AgriVision</div>
            <div class="nav-links">
                <a href="/" class="nav-item">
                    <span class="nav-icon">üè†</span> Dashboard
                </a>
                <a href="/predict_yield" class="nav-item active">
                    <span class="nav-icon">üåæ</span> Yield Prediction
                </a>
                <a href="/recommend_crop" class="nav-item">
                    <span class="nav-icon">üß™</span> Crop Recommend
                </a>
            </div>
        </div>

        <div class="main-content">
            <div class="page-header" style="display: flex; justify-content: space-between; align-items: flex-start;">
                <div>
                    <h1 class="page-title">Analytics Report</h1>
                    <p class="page-subtitle">Deep dive into your uploaded dataset.</p>
                </div>
                <a href="{{ url_for('download_file', filename='predicted_yield.csv') }}" class="btn">Download Full CSV
                    ‚¨áÔ∏è</a>
            </div>

            <div class="dashboard-grid" style="grid-template-columns: repeat(4, 1fr); margin-bottom: 30px;">
                <div class="glass-card" style="text-align: center; padding: 15px;">
                    <div style="font-size: 0.9rem; opacity: 0.7;">Records Processed</div>
                    <div class="stat-number">{{ total_rows }}</div>
                </div>
                <div class="glass-card" style="text-align: center; padding: 15px;">
                    <div style="font-size: 0.9rem; opacity: 0.7;">Total Forecast</div>
                    <div class="stat-number">{{ total_yield }} T</div>
                </div>
                <div class="glass-card" style="text-align: center; padding: 15px;">
                    <div style="font-size: 0.9rem; opacity: 0.7;">Avg Yield</div>
                    <div class="stat-number">{{ avg_yield }}</div>
                </div>
                <div class="glass-card" style="text-align: center; padding: 15px;">
                    <div style="font-size: 0.9rem; opacity: 0.7;">Top State</div>
                    <div class="stat-number" style="font-size: 1.2rem; margin-top: 15px;">{{ top_state }}</div>
                </div>
            </div>

            <div class="glass-card">
                <h3>Visual Insights</h3>
                <div class="charts-container" style="margin-top: 20px;">
                    <div style="height: 300px;">
                        <canvas id="stateChart"></canvas>
                    </div>
                    <div style="height: 300px; display: flex; justify-content: center;">
                        <canvas id="cropChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="glass-card">
                <h3>üìã Data Preview (Top 50 Rows)</h3>
                <div style="overflow-x: auto; margin-top: 15px;">
                    <table style="width: 100%; border-collapse: collapse; color: #ddd; font-size: 0.9rem;">
                        <thead>
                            <tr style="background: rgba(0,0,0,0.3); border-bottom: 2px solid var(--primary-color);">
                                {% for col in columns %}
                                <th style="padding: 12px; text-align: left;">{{ col }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in preview_data %}
                            <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                                {% for item in row %}
                                <td style="padding: 10px;">{{ item }}</td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Data from Flask - Properly parsed as JSON
        const stateLabels = JSON.parse('{{ state_labels | tojson | safe }}');
        const stateData = JSON.parse('{{ state_yields | tojson | safe }}');
        const cropLabels = JSON.parse('{{ crop_labels | tojson | safe }}');
        const cropData = JSON.parse('{{ crop_counts | tojson | safe }}');

        // State Chart
        const stateChart = new Chart(document.getElementById('stateChart'), {
            type: 'bar',
            data: {
                labels: stateLabels,
                datasets: [{
                    label: 'Average Yield (Tonnes)',
                    data: stateData,
                    backgroundColor: 'rgba(46, 204, 113, 0.6)',
                    borderColor: '#2ecc71',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Top 5 Yielding States',
                        color: '#fff',
                        font: { size: 16, weight: 'bold' }
                    },
                    legend: {
                        labels: { color: '#fff' }
                    }
                },
                scales: {
                    y: {
                        ticks: { color: '#ddd' },
                        grid: { color: 'rgba(255,255,255,0.1)' },
                        beginAtZero: true
                    },
                    x: {
                        ticks: { color: '#ddd' },
                        grid: { display: false }
                    }
                }
            }
        });

        // Crop Chart
        const cropChart = new Chart(document.getElementById('cropChart'), {
            type: 'doughnut',
            data: {
                labels: cropLabels,
                datasets: [{
                    label: 'Records',
                    data: cropData,
                    backgroundColor: [
                        '#f1c40f', '#e67e22', '#e74c3c', '#9b59b6', '#3498db', '#2ecc71'
                    ],
                    borderColor: '#1a1a1a',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Crop Distribution (Top 5)',
                        color: '#fff',
                        font: { size: 16, weight: 'bold' }
                    },
                    legend: {
                        position: 'right',
                        labels: {
                            color: '#fff',
                            padding: 15
                        }
                    }
                }
            }
        });
    </script>
</body>

</html>