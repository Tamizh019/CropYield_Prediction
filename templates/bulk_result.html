<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard - AgriVision</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(46, 204, 113, 0.1);
            border: 1px solid rgba(46, 204, 113, 0.3);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #2ecc71;
            margin: 10px 0;
        }

        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (max-width: 768px) {
            .charts-container {
                grid-template-columns: 1fr;
            }
        }

        .chart-wrapper {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 10px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            color: #ddd;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            text-align: left;
        }

        .data-table th {
            background: rgba(0, 0, 0, 0.3);
            color: #2ecc71;
        }

        .download-bar {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
    </style>
</head>

<body>
    <nav>
        <a href="/" class="nav-brand">AgriVision AI</a>
        <div class="nav-links">
            <a href="/">Home</a>
            <a href="/predict_yield">Back to Prediction</a>
        </div>
    </nav>

    <div class="container">
        <div class="hero" style="padding: 20px; text-align: left;">
            <h1>Bulk Analytics Report</h1>
            <p>Advanced insights from your uploaded dataset.</p>
        </div>

        <!-- Download Section -->
        <div class="download-bar">
            <div>
                <h3>Analysis Complete ‚úÖ</h3>
                <p>Processed {{ total_rows }} records.</p>
            </div>
            <a href="{{ url_for('download_file', filename='predicted_yield.csv') }}" class="btn">Download Full CSV
                ‚¨áÔ∏è</a>
        </div>

        <!-- Summary Cards -->
        <div class="analytics-grid">
            <div class="stat-card">
                <h3>Total Forecast</h3>
                <div class="stat-number">{{ total_yield }} T</div>
                <p>Predicted Production</p>
            </div>
            <div class="stat-card">
                <h3>Average Yield</h3>
                <div class="stat-number">{{ avg_yield }} T/ha</div>
                <p>Performance Metric</p>
            </div>
            <div class="stat-card">
                <h3>Top State</h3>
                <div class="stat-number" style="font-size: 1.5rem;">{{ top_state }}</div>
                <p>Most Productive Region</p>
            </div>
            <div class="stat-card">
                <h3>Top Crop</h3>
                <div class="stat-number" style="font-size: 1.5rem;">{{ top_crop }}</div>
                <p>Highest Yielding Crop</p>
            </div>
        </div>

        <!-- Charts -->
        <div class="charts-container">
            <div class="chart-wrapper">
                <canvas id="stateChart"></canvas>
            </div>
            <div class="chart-wrapper">
                <canvas id="cropChart"></canvas>
            </div>
        </div>

        <!-- Preview Table -->
        <div class="glass-card">
            <h3>üìã Data Preview (Top 10 Rows)</h3>
            <div style="overflow-x: auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            {% for col in columns %}
                            <th>{{ col }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in preview_data %}
                        <tr>
                            {% for item in row %}
                            <td>{{ item }}</td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

<script>
    // Data from Flask - Properly parsed as JSON
    const stateLabels = JSON.parse('{{ state_labels | tojson | safe }}');
    const stateData = JSON.parse('{{ state_yields | tojson | safe }}');
    const cropLabels = JSON.parse('{{ crop_labels | tojson | safe }}');
    const cropData = JSON.parse('{{ crop_counts | tojson | safe }}');

    // State Chart
    const stateChart = new Chart(document.getElementById('stateChart'), {
        type: 'bar',
        data: {
            labels: stateLabels,
            datasets: [{
                label: 'Average Yield (Tonnes)',
                data: stateData,
                backgroundColor: 'rgba(46, 204, 113, 0.6)',
                borderColor: '#2ecc71',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: { 
                    display: true, 
                    text: 'Top 5 Yielding States', 
                    color: '#fff',
                    font: { size: 16, weight: 'bold' }
                },
                legend: { 
                    labels: { color: '#fff' } 
                }
            },
            scales: {
                y: { 
                    ticks: { color: '#ddd' }, 
                    grid: { color: 'rgba(255,255,255,0.1)' },
                    beginAtZero: true
                },
                x: { 
                    ticks: { color: '#ddd' }, 
                    grid: { display: false } 
                }
            }
        }
    });

    // Crop Chart
    const cropChart = new Chart(document.getElementById('cropChart'), {
        type: 'doughnut',
        data: {
            labels: cropLabels,
            datasets: [{
                label: 'Records',
                data: cropData,
                backgroundColor: [
                    '#f1c40f', '#e67e22', '#e74c3c', '#9b59b6', '#3498db', '#2ecc71'
                ],
                borderColor: '#1a1a1a',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: { 
                    display: true, 
                    text: 'Crop Distribution (Top 5)', 
                    color: '#fff',
                    font: { size: 16, weight: 'bold' }
                },
                legend: { 
                    position: 'bottom',
                    labels: { 
                        color: '#fff',
                        padding: 15
                    } 
                }
            }
        }
    });
</script>

</body>

</html>