{% extends "base.html" %}

{% block title %}Plant Doctor - AgriVision{% endblock %}

{% block head %}
<style>
    .upload-zone {
        border: 2px dashed rgba(255, 255, 255, 0.3);
        border-radius: 16px;
        padding: 60px 40px;
        text-align: center;
        transition: all 0.3s;
        cursor: pointer;
        background: rgba(255, 255, 255, 0.05);
    }

    .upload-zone:hover {
        border-color: var(--success);
        background: rgba(76, 175, 80, 0.1);
    }

    .upload-zone.dragover {
        border-color: var(--primary);
        background: rgba(99, 102, 241, 0.1);
    }

    .upload-icon {
        font-size: 4rem;
        margin-bottom: 20px;
    }

    .preview-image {
        max-width: 300px;
        border-radius: 12px;
        margin: 20px auto;
        display: block;
    }

    .diagnosis-card {
        background: linear-gradient(135deg, rgba(76, 175, 80, 0.2), rgba(76, 175, 80, 0.05));
        border-radius: 16px;
        padding: 30px;
        margin-top: 30px;
    }

    .severity-badge {
        padding: 6px 16px;
        border-radius: 20px;
        font-weight: bold;
        display: inline-block;
    }

    .severity-None {
        background: rgba(76, 175, 80, 0.3);
        color: #4caf50;
    }

    .severity-Moderate {
        background: rgba(255, 193, 7, 0.3);
        color: #ffc107;
    }

    .severity-Severe,
    .severity-Critical {
        background: rgba(244, 67, 54, 0.3);
        color: #f44336;
    }

    .confidence-bar {
        height: 8px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 4px;
        overflow: hidden;
        margin-top: 10px;
    }

    .confidence-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--success), #8bc34a);
        border-radius: 4px;
        transition: width 0.5s;
    }

    .treatment-card {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        padding: 20px;
        margin-top: 15px;
    }

    .treatment-card h4 {
        margin-bottom: 10px;
    }

    /* AI Advice specific styling */
    .ai-advice-content ul,
    .ai-advice-content ol {
        padding-left: 20px;
        margin: 10px 0;
    }

    .ai-advice-content li {
        margin-bottom: 8px;
    }

    .ai-advice-content strong {
        color: #8bc34a;
        /* Matches success theme */
    }

    .ai-advice-content p {
        margin-bottom: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">ðŸ©º AI Plant Doctor</h1>
    <p class="page-subtitle">Upload a photo of a leaf to detect diseases instantly</p>

    {% if supported_crops %}
    <div style="margin-top:15px; display:flex; gap:8px; justify-content:center; flex-wrap:wrap;">
        <span style="font-size:0.9rem; color:var(--muted-text); align-self:center;">Supports:</span>
        {% for crop in supported_crops %}
        <span
            style="background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.1); padding:4px 12px; border-radius:20px; font-size:0.85rem; color: #fff;">
            {{ crop }}
        </span>
        {% endfor %}
    </div>
    {% endif %}
</div>

<div class="glass-card">
    <form method="POST" enctype="multipart/form-data" id="uploadForm">
        <div class="upload-zone" id="dropZone" onclick="document.getElementById('imageInput').click()">
            <div class="upload-icon">ðŸ“·</div>
            <h3>Drop leaf image here</h3>
            <p style="color: var(--muted-text)">or click to browse (JPG, PNG)</p>
            <input type="file" name="image" id="imageInput" accept="image/*" hidden required>
        </div>
        <img id="preview" class="preview-image" style="display:none">
        <button type="submit" class="btn btn-primary btn-lg" style="width:100%; margin-top:20px">
            ðŸ”¬ Analyze Leaf
        </button>
    </form>

    {% if error %}
    <div class="alert alert-error" style="margin-top:20px">{{ error }}</div>
    {% endif %}

    {% if result and result.success %}
    <div class="diagnosis-card">
        <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:15px">
            <div>
                <h2 style="margin:0">{{ result.prediction.disease_name }}</h2>
                <p style="color:var(--muted-text); margin:5px 0">{{ result.prediction.crop }}</p>
            </div>
            <span class="severity-badge severity-{{ result.prediction.severity }}">
                {{ result.prediction.severity }}
            </span>
        </div>

        <div style="margin-top:20px">
            <div style="display:flex; justify-content:space-between">
                <span>Confidence</span>
                <span>{{ result.prediction.confidence }}%</span>
            </div>
            <div class="confidence-bar">
                <div class="confidence-fill" style="width:{{ result.prediction.confidence }}%"></div>
            </div>
        </div>

        {% if result.diagnosis %}
        <div class="treatment-card">
            <h4>ðŸ“‹ Symptoms</h4>
            <p>{{ result.diagnosis.symptoms }}</p>
            <h4 style="margin-top:15px">ðŸ¦  Cause</h4>
            <p>{{ result.diagnosis.cause }}</p>
        </div>
        {% endif %}

        {% if result.treatment %}
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-top:20px">
            <div class="treatment-card">
                <h4>ðŸ’Š Chemical Treatment</h4>
                <p>{{ result.treatment.chemical }}</p>
            </div>
            <div class="treatment-card">
                <h4>ðŸŒ¿ Organic Treatment</h4>
                <p>{{ result.treatment.organic }}</p>
            </div>
        </div>
        {% endif %}

        {% if result.ai_advice %}
        <div class="treatment-card" style="border-left:3px solid var(--primary)">
            <h4>ðŸ¤– AI Advice</h4>
            <div class="ai-advice-content">
                {{ result.ai_advice | safe }}
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    const dropZone = document.getElementById('dropZone');
    const imageInput = document.getElementById('imageInput');
    const preview = document.getElementById('preview');

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => {
        dropZone.addEventListener(e, ev => ev.preventDefault());
    });
    dropZone.addEventListener('dragover', () => dropZone.classList.add('dragover'));
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
    dropZone.addEventListener('drop', e => {
        dropZone.classList.remove('dragover');
        imageInput.files = e.dataTransfer.files;
        showPreview(e.dataTransfer.files[0]);
    });
    imageInput.addEventListener('change', e => showPreview(e.target.files[0]));

    function showPreview(file) {
        if (file) {
            const reader = new FileReader();
            reader.onload = e => {
                preview.src = e.target.result;
                preview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
    }
</script>
{% endblock %}