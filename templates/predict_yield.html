{% extends "base.html" %}

{% block title %}Smart Yield Predictor - AgriVision{% endblock %}

{% block head %}
<style>
    /* Tab System */
    .tab-container {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-bottom: 30px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        padding-bottom: 0;
    }

    .main-tab {
        padding: 15px 30px;
        color: var(--muted-text);
        cursor: pointer;
        font-weight: 600;
        font-size: 1.1rem;
        border-bottom: 3px solid transparent;
        transition: all 0.3s;
        margin-bottom: -1px;
    }

    .main-tab:hover {
        color: var(--text-color);
    }

    .main-tab.active {
        color: var(--primary-color);
        border-bottom-color: var(--primary-color);
    }

    /* Wizard Styles */
    .wizard-container {
        max-width: 800px;
        margin: 0 auto;
    }

    .wizard-progress {
        display: flex;
        justify-content: space-between;
        margin-bottom: 30px;
        position: relative;
    }

    .wizard-progress::before {
        content: '';
        position: absolute;
        top: 20px;
        left: 10%;
        right: 10%;
        height: 3px;
        background: rgba(255, 255, 255, 0.1);
        z-index: 0;
    }

    .progress-step {
        display: flex;
        flex-direction: column;
        align-items: center;
        z-index: 1;
        cursor: pointer;
        transition: all 0.3s;
    }

    .step-number {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.1);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-bottom: 8px;
        border: 2px solid transparent;
        transition: all 0.3s;
    }

    .progress-step.active .step-number {
        background: var(--primary-color);
        border-color: var(--primary-color);
        box-shadow: 0 0 20px rgba(76, 175, 80, 0.4);
    }

    .progress-step.completed .step-number {
        background: var(--primary-color);
        border-color: var(--primary-color);
    }

    .step-label {
        font-size: 0.75rem;
        color: var(--muted-text);
        text-align: center;
    }

    .progress-step.active .step-label {
        color: var(--primary-color);
        font-weight: 600;
    }

    .wizard-step {
        display: none;
        animation: fadeIn 0.3s ease;
    }

    .wizard-step.active {
        display: block;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .step-header {
        text-align: center;
        margin-bottom: 30px;
    }

    .step-header h2 {
        font-size: 1.5rem;
        margin-bottom: 10px;
    }

    .step-header p {
        color: var(--muted-text);
    }

    /* Selection Cards */
    .selection-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin: 20px 0;
    }

    .selection-card {
        background: rgba(255, 255, 255, 0.05);
        border: 2px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
    }

    .selection-card:hover {
        border-color: var(--primary-color);
        background: rgba(76, 175, 80, 0.1);
    }

    .selection-card.selected {
        border-color: var(--primary-color);
        background: rgba(76, 175, 80, 0.2);
        box-shadow: 0 0 20px rgba(76, 175, 80, 0.3);
    }

    .card-icon {
        font-size: 2.5rem;
        margin-bottom: 10px;
    }

    .card-title {
        font-weight: 600;
        margin-bottom: 5px;
    }

    .card-desc {
        font-size: 0.8rem;
        color: var(--muted-text);
    }

    /* Navigation */
    .wizard-nav {
        display: flex;
        justify-content: space-between;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .custom-select {
        width: 100%;
        padding: 12px 15px;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: var(--text-color);
        font-size: 1rem;
        cursor: pointer;
    }

    .custom-select option {
        background: #1a1a2e;
    }

    /* Results */
    .prediction-card {
        text-align: center;
        padding: 30px;
        background: linear-gradient(135deg, rgba(76, 175, 80, 0.2), rgba(76, 175, 80, 0.05));
        border: 1px solid var(--primary-color);
        border-radius: 20px;
        margin-bottom: 30px;
    }

    .yield-value {
        font-size: 3.5rem;
        font-weight: 800;
        color: var(--primary-color);
        text-shadow: 0 0 30px rgba(76, 175, 80, 0.3);
    }

    .yield-unit {
        font-size: 1.2rem;
        color: var(--muted-text);
    }

    .estimated-conditions {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 16px;
        padding: 20px;
        margin-top: 20px;
    }

    .condition-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 15px;
    }

    .condition-item {
        text-align: center;
    }

    .condition-value {
        font-size: 1.2rem;
        font-weight: bold;
        color: var(--text-color);
    }

    .condition-label {
        font-size: 0.8rem;
        color: var(--muted-text);
    }

    /* Bulk Upload Styles */
    .bulk-upload-zone {
        border: 2px dashed rgba(255, 255, 255, 0.2);
        border-radius: 16px;
        padding: 40px;
        text-align: center;
        transition: all 0.3s;
        background: rgba(255, 255, 255, 0.02);
    }

    .bulk-upload-zone:hover {
        border-color: var(--primary-color);
        background: rgba(76, 175, 80, 0.05);
    }

    .upload-icon {
        font-size: 3rem;
        margin-bottom: 15px;
    }

    input[type="file"] {
        display: none;
    }

    .file-btn {
        display: inline-block;
        padding: 10px 20px;
        background: var(--primary-color);
        color: #000;
        font-weight: bold;
        border-radius: 8px;
        cursor: pointer;
        transition: transform 0.2s;
    }

    .file-btn:hover {
        transform: scale(1.05);
    }

    .requirements-list {
        margin-top: 30px;
        text-align: left;
        background: rgba(0, 0, 0, 0.2);
        padding: 20px;
        border-radius: 10px;
    }

    .req-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 10px;
        margin-top: 10px;
    }

    .req-tag {
        background: rgba(255, 255, 255, 0.1);
        padding: 5px 10px;
        border-radius: 5px;
        font-size: 0.8rem;
        text-align: center;
    }

    /* Step 4 Styles */
    .optional-badge {
        background: rgba(255, 255, 255, 0.1);
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 0.7rem;
        margin-left: 5px;
        vertical-align: middle;
    }

    @media (max-width: 768px) {
        .condition-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">üåæ Smart Yield Predictor</h1>
    <p class="page-subtitle">AI-powered estimation based on your local conditions</p>
</div>

{% if prediction %}
<!-- PREDICTION RESULT VIEW (Same as before) -->
<div class="glass-card">
    <div class="card-header">
        <h3>üéâ Prediction Complete</h3>
        <a href="/predict_yield" class="btn btn-secondary" style="padding: 8px 16px;">New Prediction</a>
    </div>

    <div class="prediction-card">
        <div class="yield-icon">‚öñÔ∏è</div>
        <div class="yield-value">{{ prediction }}</div>
        <div class="yield-unit">Tonnes / Hectare</div>
        <div style="margin-top: 10px; color: var(--primary-color);">Predicted Yield</div>
    </div>

    {% if input_data and input_data.is_estimated %}
    <div class="estimated-conditions">
        <h4 style="margin-bottom: 15px; display: flex; align-items: center; justify-content: center; gap: 10px;">
            <span>ü§ñ AI Estimated Conditions</span>
            <span class="badge badge-purple" style="font-size: 0.7rem;">Auto-Calculated</span>
        </h4>
        <div class="condition-grid">
            <div class="condition-item">
                <div class="condition-value">{{ input_data.Temperature }}¬∞C</div>
                <div class="condition-label">Temperature</div>
            </div>
            <div class="condition-item">
                <div class="condition-value">{{ input_data.Humidity }}%</div>
                <div class="condition-label">Humidity</div>
            </div>
            <div class="condition-item">
                <div class="condition-value">{{ input_data.Rainfall }}mm</div>
                <div class="condition-label">Rainfall</div>
            </div>
            <div class="condition-item">
                <div class="condition-value">{{ input_data.pH }}</div>
                <div class="condition-label">Soil pH</div>
            </div>
        </div>
        <p style="text-align: center; font-size: 0.8rem; color: var(--muted-text); margin-top: 15px;">
            *Based on {{ input_data.District_Name }} climate data for {{ input_data.Season }}.
        </p>
    </div>
    {% endif %}

    {% if ai_insight %}
    <div class="ai-insights-container" style="margin-top: 30px;">
        <div class="ai-header">
            <h3>üìà AI Agronomist Analysis</h3>
        </div>
        <div class="ai-content">
            <div class="ai-formatted">{{ ai_insight | safe }}</div>
        </div>
        <div class="ai-footer">
            <small>Powered by Gemini 2.0 Flash</small>
        </div>
    </div>
    {% endif %}
</div>

{% else %}
<!-- INPUT FORMS WITH TABS -->
<div class="glass-card wizard-container">

    <!-- Top Level Tabs -->
    <div class="tab-container">
        <div class="main-tab active" onclick="switchMainTab('single')">üìù Single Prediction</div>
        <div class="main-tab" onclick="switchMainTab('bulk')">üìÇ Bulk Analysis</div>
    </div>

    <!-- SINGLE PREDICTION TAB (Unified Flow) -->
    <div id="singlePredictionTab">

        <!-- Progress Bar (4 Steps) -->
        <div class="wizard-progress">
            <div class="progress-step active" data-step="1">
                <div class="step-number">1</div>
                <div class="step-label">Location</div>
            </div>
            <div class="progress-step" data-step="2">
                <div class="step-number">2</div>
                <div class="step-label">Crop</div>
            </div>
            <div class="progress-step" data-step="3">
                <div class="step-number">3</div>
                <div class="step-label">Season</div>
            </div>
            <div class="progress-step" data-step="4">
                <div class="step-number">4</div>
                <div class="step-label">Conditions</div>
            </div>
        </div>

        <form action="/predict_yield" method="POST" id="yieldForm">

            <!-- Step 1: Location -->
            <div class="wizard-step active" data-step="1">
                <div class="step-header">
                    <h2>üìç Where is your farm?</h2>
                    <p>We'll fetch local climate data for you</p>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>State</label>
                        <select name="State_Name" id="stateSelect" class="custom-select" required
                            onchange="loadDistricts()">
                            <option value="">Select State</option>
                            <option value="Andhra Pradesh">Andhra Pradesh</option>
                            <option value="Assam">Assam</option>
                            <option value="Bihar">Bihar</option>
                            <option value="Chhattisgarh">Chhattisgarh</option>
                            <option value="Gujarat">Gujarat</option>
                            <option value="Haryana">Haryana</option>
                            <option value="Himachal Pradesh">Himachal Pradesh</option>
                            <option value="Jharkhand">Jharkhand</option>
                            <option value="Karnataka">Karnataka</option>
                            <option value="Kerala">Kerala</option>
                            <option value="Madhya Pradesh">Madhya Pradesh</option>
                            <option value="Maharashtra">Maharashtra</option>
                            <option value="Odisha">Odisha</option>
                            <option value="Punjab">Punjab</option>
                            <option value="Rajasthan">Rajasthan</option>
                            <option value="Tamil Nadu">Tamil Nadu</option>
                            <option value="Telangana">Telangana</option>
                            <option value="Uttar Pradesh">Uttar Pradesh</option>
                            <option value="Uttarakhand">Uttarakhand</option>
                            <option value="West Bengal">West Bengal</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>District</label>
                        <select name="District_Name" id="districtSelect" class="custom-select" required>
                            <option value="">Select District</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Step 2: Crop Details -->
            <div class="wizard-step" data-step="2">
                <div class="step-header">
                    <h2>üåæ What are you growing?</h2>
                    <p>Enter crop type and land area</p>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Crop Type</label>
                        <select name="Crop" class="custom-select" required>
                            <option value="Rice">Rice</option>
                            <option value="Wheat">Wheat</option>
                            <option value="Maize">Maize</option>
                            <option value="Cotton">Cotton</option>
                            <option value="Sugarcane">Sugarcane</option>
                            <option value="Groundnut">Groundnut</option>
                            <option value="Potato">Potato</option>
                            <option value="Onion">Onion</option>
                            <option value="Tomato">Tomato</option>
                            <option value="Banana">Banana</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Area (Hectares)</label>
                        <input type="number" step="0.01" name="Area" class="custom-select" placeholder="e.g., 2.5"
                            required
                            style="background: rgba(255,255,255,0.05); color:white; border:1px solid rgba(255,255,255,0.1);">
                    </div>
                </div>
                <input type="hidden" name="Crop_Year" value="2025">
            </div>

            <!-- Step 3: Season -->
            <div class="wizard-step" data-step="3">
                <div class="step-header">
                    <h2>üóìÔ∏è Which season?</h2>
                    <p>Affects weather calculation</p>
                </div>
                <div class="selection-grid">
                    <div class="selection-card" data-value="Kharif" onclick="selectCard(this, 'Season')">
                        <div class="card-icon">‚òî</div>
                        <div class="card-title">Kharif</div>
                        <div class="card-desc">Monsoon (Jun-Oct)</div>
                    </div>
                    <div class="selection-card" data-value="Rabi" onclick="selectCard(this, 'Season')">
                        <div class="card-icon">‚ùÑÔ∏è</div>
                        <div class="card-title">Rabi</div>
                        <div class="card-desc">Winter (Nov-Apr)</div>
                    </div>
                    <div class="selection-card" data-value="Zaid" onclick="selectCard(this, 'Season')">
                        <div class="card-icon">‚òÄÔ∏è</div>
                        <div class="card-title">Zaid</div>
                        <div class="card-desc">Summer (Mar-Jun)</div>
                    </div>
                    <div class="selection-card" data-value="Whole Year" onclick="selectCard(this, 'Season')">
                        <div class="card-icon">üóìÔ∏è</div>
                        <div class="card-title">Annual</div>
                        <div class="card-desc">Whole Year Crop</div>
                    </div>
                </div>
                <input type="hidden" name="Season" id="SeasonInput" value="Kharif">
            </div>

            <!-- Step 4: Optional Details (Unified) -->
            <div class="wizard-step" data-step="4">
                <div class="step-header">
                    <h2>üî¨ Specific Conditions?</h2>
                    <p>Do you have soil/weather data? If not, leave blank and we'll estimate it.</p>
                </div>

                <div class="form-section">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Temperature (¬∞C) <span class="optional-badge">Optional</span></label>
                            <input type="number" step="0.1" name="Temperature" class="custom-select"
                                placeholder="e.g. 28.5 (or leave empty)">
                        </div>
                        <div class="form-group">
                            <label>Humidity (%) <span class="optional-badge">Optional</span></label>
                            <input type="number" step="0.1" name="Humidity" class="custom-select"
                                placeholder="e.g. 70 (or leave empty)">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Rainfall (mm) <span class="optional-badge">Optional</span></label>
                            <input type="number" step="0.1" name="Rainfall" class="custom-select"
                                placeholder="e.g. 950 (or leave empty)">
                        </div>
                        <div class="form-group">
                            <label>Soil pH <span class="optional-badge">Optional</span></label>
                            <input type="number" step="0.1" name="pH" class="custom-select"
                                placeholder="e.g. 6.5 (or leave empty)">
                        </div>
                    </div>

                    <div
                        style="background: rgba(76, 175, 80, 0.1); border-left: 3px solid var(--primary-color); padding: 15px; margin-top: 20px; border-radius: 6px;">
                        <stroAg>ü§ñ Smart Detection:</strong> If you leave these fields empty, AgriVision will
                            automatically calculate them using regional climate data for your selected location and
                            season.
                    </div>
                </div>
            </div>

            <!-- Navigation Buttons -->
            <div class="wizard-nav">
                <button type="button" class="btn btn-back" id="prevBtn" onclick="changeStep(-1)"
                    style="visibility: hidden;">
                    ‚Üê Back
                </button>
                <button type="button" class="btn btn-primary" id="nextBtn" onclick="changeStep(1)">
                    Next ‚Üí
                </button>
                <button type="submit" class="btn btn-primary" id="submitBtn" style="display: none;">
                    üöÄ Predict Yield
                </button>
            </div>
        </form>
    </div>

    <!-- BULK PREDICTION TAB -->
    <div id="bulkPredictionTab" style="display: none;">
        <div class="card-header">
            <h3>üìÇ Bulk Yield Analysis</h3>
            <span class="badge badge-purple">CSV Upload</span>
        </div>

        <div style="text-align: center; margin-bottom: 25px; color: var(--muted-text);">
            Upload a CSV file containing multiple farm records. The system will analyze all of them,<br>
            provide a downloadable report, and generate overall insights.
        </div>

        <form action="/predict_yield_bulk" method="POST" enctype="multipart/form-data">
            <div class="bulk-upload-zone" onclick="document.getElementById('csvFile').click()">
                <div class="upload-icon">üìÑ</div>
                <h4 style="margin-bottom: 10px;">Drag & Drop or Click to Upload</h4>
                <p style="color: var(--muted-text); font-size: 0.9rem;">Accepted format: .CSV</p>
                <input type="file" name="file" id="csvFile" accept=".csv" required onchange="updateFileName(this)">
                <div style="margin-top: 20px;">
                    <span class="file-btn">Choose File</span>
                </div>
                <div id="fileName" style="margin-top: 15px; color: var(--primary-color);"></div>
            </div>

            <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 25px; padding: 15px;">
                üìä Upload & Analyze Data
            </button>
        </form>

        <div class="requirements-list">
            <h4>üìã Required CSV Columns</h4>
            <div class="req-grid">
                <span class="req-tag">State Name</span>
                <span class="req-tag">Dist Name</span>
                <span class="req-tag">Year</span>
                <span class="req-tag">Crop</span>
                <span class="req-tag">Area_ha</span>
                <span class="req-tag">Temperature_C</span>
                <span class="req-tag">Humidity_%</span>
                <span class="req-tag">Rainfall_mm</span>
                <span class="req-tag">pH</span>
            </div>
            <div style="margin-top: 15px; font-size: 0.85rem; color: var(--danger-color);">
                ‚ö†Ô∏è Note: Ensure headers match exactly. Missing columns will cause errors.
            </div>
        </div>
    </div>

</div>
{% endif %}

{% if error %}
<div class="glass-card" style="border-color: #ff6b6b; margin-top: 20px;">
    <div style="color: #ff6b6b; text-align: center; padding: 15px;">{{ error }}</div>
</div>
{% endif %}

<script>
    // Tab Switching
    function switchMainTab(tab) {
        const singleTab = document.getElementById('singlePredictionTab');
        const bulkTab = document.getElementById('bulkPredictionTab');
        const tabs = document.querySelectorAll('.main-tab');

        if (tab === 'single') {
            singleTab.style.display = 'block';
            bulkTab.style.display = 'none';
            tabs[0].classList.add('active');
            tabs[1].classList.remove('active');
        } else {
            singleTab.style.display = 'none';
            bulkTab.style.display = 'block';
            tabs[0].classList.remove('active');
            tabs[1].classList.add('active');
        }
    }

    // CSV File Name
    function updateFileName(input) {
        const display = document.getElementById('fileName');
        if (input.files && input.files.length > 0) {
            display.textContent = "Selected: " + input.files[0].name;
        } else {
            display.textContent = "";
        }
    }

    // Wizard Logic
    let currentStep = 1;
    const totalSteps = 4; // Now 4 Steps

    function changeStep(direction) {
        const steps = document.querySelectorAll('#singlePredictionTab .wizard-step');
        const progressSteps = document.querySelectorAll('.progress-step');

        // Validation for current step
        if (direction === 1) {
            const currentStepEl = steps[currentStep - 1];
            // Only check inputs that are marked as required
            const requiredInputs = currentStepEl.querySelectorAll('select[required], input[required]');
            for (let input of requiredInputs) {
                if (!input.value) {
                    alert('Please fill in the required fields.');
                    input.focus();
                    return;
                }
            }
        }

        steps[currentStep - 1].classList.remove('active');
        progressSteps[currentStep - 1].classList.remove('active');
        progressSteps[currentStep - 1].classList.add('completed');

        currentStep += direction;

        steps[currentStep - 1].classList.add('active');
        progressSteps[currentStep - 1].classList.add('active');

        // Button Visibility
        document.getElementById('prevBtn').style.visibility = currentStep === 1 ? 'hidden' : 'visible';

        if (currentStep === totalSteps) {
            document.getElementById('nextBtn').style.display = 'none';
            document.getElementById('submitBtn').style.display = 'block';
        } else {
            document.getElementById('nextBtn').style.display = 'block';
            document.getElementById('submitBtn').style.display = 'none';
        }
    }

    function selectCard(card, inputName) {
        // Remove class from siblings
        const parent = card.parentElement;
        parent.querySelectorAll('.selection-card').forEach(c => c.classList.remove('selected'));
        card.classList.add('selected');

        // Update hidden input
        document.getElementById(inputName + 'Input').value = card.dataset.value;
    }

    // Load Districts
    async function loadDistricts() {
        const stateSelect = document.getElementById('stateSelect');
        const distSelect = document.getElementById('districtSelect');
        const state = stateSelect.value;

        distSelect.innerHTML = '<option value="">Loading...</option>';

        if (state) {
            try {
                const response = await fetch(`/api/districts/${state}`);
                const data = await response.json();

                distSelect.innerHTML = '<option value="">Select District</option>';
                data.districts.forEach(dist => {
                    distSelect.innerHTML += `<option value="${dist}">${dist}</option>`;
                });
            } catch (e) {
                console.error("Error loading districts", e);
                distSelect.innerHTML = '<option value="">Error loading</option>';
            }
        } else {
            distSelect.innerHTML = '<option value="">Select District</option>';
        }
    }
</script>
{% endblock %}